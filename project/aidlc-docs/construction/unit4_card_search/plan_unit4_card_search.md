# Unit4: Card Search & Display - 도메인 모델 설계 계획

## 개요
Unit4는 저장된 카드들을 조회, 검색, 필터링하는 기능을 담당하는 독립적인 단위입니다. 내 카드 검색과 공개 카드 검색을 분리하여 처리합니다.

## 설계 계획

### 1단계: 도메인 분석 및 이해
- [x] 1.1 사용자 스토리 분석 (US-007, US-008, US-009, US-010, US-011)
- [x] 1.2 핵심 비즈니스 규칙 도출
- [x] 1.3 도메인 전문가 언어(Ubiquitous Language) 정의
- [x] 1.4 기존 Unit들과의 연관관계 분석

### 2단계: 전술적 DDD 구성 요소 설계
- [x] 2.1 애그리게이트 식별 및 경계 설정
- [x] 2.2 엔티티 설계
- [x] 2.3 값 객체 설계
- [x] 2.4 도메인 서비스 설계
- [x] 2.5 도메인 이벤트 설계
- [x] 2.6 리포지토리 인터페이스 설계

### 3단계: 검색 및 필터링 로직 설계
- [x] 3.1 검색 쿼리 모델 설계 (내 카드 vs 공개 카드)
- [x] 3.2 필터링 전략 설계
- [x] 3.3 정렬 및 페이징 전략 설계 (하이브리드 방식)
- [x] 3.4 검색 성능 최적화 전략

### 4단계: 통합 및 일관성 검토
- [x] 4.1 기존 Unit들과의 일관성 검토
- [x] 4.2 Integration Contract 업데이트 (완료)
- [x] 4.3 오류 코드 추가 (완료)
- [x] 4.4 도메인 모델 문서 작성

## 주요 고려사항

### 새로운 요구사항 반영
- **카드 공개 설정**: Unit3에 IsPublic 속성 추가 완료
- **검색 범위 분리**: 내 카드 검색 vs 공개 카드 검색
- **태그 제약**: 단일 태그만 선택 가능
- **공개 카드 검색 제약**: 태그 OR 키워드 중 하나만 사용

### 페이징 전략 (확정)
1. **내 카드 검색**: 커서 기반 페이징
   - 실시간 업데이트 일관성
   - 카테고리 필터링과 조합 최적화
   - 무한 스크롤 UX

2. **공개 카드 검색**: 오프셋 기반 페이징
   - 관련도 기반 정렬
   - 총 결과 수 표시
   - 페이지 번호 네비게이션

### 기존 Unit들과의 연관관계
- **Unit1 (Authentication)**: UserId를 통한 사용자별 검색 범위 제한
- **Unit2 (Category Management)**: CategoryId를 통한 카테고리 필터링 (내 카드만)
- **Unit3 (Card Creation)**: Card 엔티티 조회 및 검색 대상, IsPublic 속성 활용

### 검색 요구사항
1. **메인 화면 카드 목록** (US-007): 최신 저장 순서 정렬, 그리드 표시
2. **카테고리별 필터링** (US-008): 특정 카테고리 카드만 조회 (내 카드만)
3. **태그 기반 검색** (US-009): 단일 태그 검색, 내 카드/공개 카드 각각
4. **내용 기반 검색** (US-010): 제목, 요약, 메모에서 키워드 검색
5. **공개 카드 검색** (US-011): 다른 사용자 공개 카드 검색 및 저장

[Question] 검색 자동완성 기능에서 제안할 항목의 우선순위는 어떻게 정하시겠습니까? (예: 최근 검색어, 인기 태그, 카드 제목 등)
[Answer] 최근 검색어 > 내 카드의 태그 > 인기 태그 순으로 해줘

[Question] 검색 결과에서 검색어 하이라이트 기능을 서버에서 처리할지, 클라이언트에서 처리할지 결정이 필요합니다.
[Answer] 클라이언트에서 처리해줘

[Question] 공개 카드를 내 계정에 저장할 때 기본 카테고리는 어떻게 설정하시겠습니까?
[Answer] 공개 카드 내 계정에 저장할 때 "공유받은 카드"를 기본으로 선택하고 사용자가 변경할 수 있어야해

## 설계 결정 사항 및 판단 근거

### 1. 페이징 전략 결정
**내 카드 검색 → 커서 기반 페이징**
- 근거: 실시간 데이터 일관성 필요, 무한 스크롤 UX, 카테고리 필터링과 조합 시 성능 우수
- 사용 시나리오: 메인 화면, 카테고리 필터링, 즐겨찾기 목록

**공개 카드 검색 → 오프셋 기반 페이징**  
- 근거: 관련도 기반 정렬, 총 결과 수 표시 필요, 페이지 번호 네비게이션 선호
- 사용 시나리오: 공개 카드 검색, 탐색 기능

### 2. 검색 제약사항 설정
**태그 단일 선택**
- 근거: UI 복잡성 감소, 검색 결과 명확성 향상
- 공개 카드에서 태그/키워드 중복 사용 금지로 검색 의도 명확화

### 3. 자동완성 우선순위
**최근 검색어 > 내 카드 태그 > 인기 태그**
- 근거: 개인화된 경험 우선, 사용자 행동 패턴 반영

### 4. 하이라이트 처리 위치
**클라이언트 처리**
- 근거: 서버 부하 감소, 실시간 반응성 향상, 다양한 하이라이트 스타일 적용 가능

### 5. 공개 카드 저장 정책
**"공유받은 카드" 기본 카테고리 + 사용자 변경 가능**
- 근거: 공유 출처 명확화, 카테고리 관리 용이성, 사용자 선택권 보장
- 구현: 저장 시 카테고리 선택 드롭다운에서 "공유받은 카드"가 기본 선택됨

## 예상 결과물
- `domain_model.md`: 완전한 도메인 모델 설계 문서
- `integration_contract.md` 업데이트 (완료)
- 새로운 오류 코드 정의 (필요시)

## 5단계: 논리적 설계 생성 계획

### 5.1 아키텍처 설계
- [x] 5.1.1 헥사고날 아키텍처 적용 (포트 & 어댑터 패턴)
- [x] 5.1.2 레이어 구조 설계 (Domain, Application, Infrastructure, Presentation)
- [x] 5.1.3 의존성 방향 정의 (내부 → 외부)
- [x] 5.1.4 이벤트 기반 아키텍처 통합

### 5.2 애플리케이션 서비스 설계
- [x] 5.2.1 검색 애플리케이션 서비스 설계
- [x] 5.2.2 공개 카드 저장 애플리케이션 서비스 설계
- [x] 5.2.3 검색 제안 애플리케이션 서비스 설계
- [x] 5.2.4 명령/쿼리 분리 (CQRS) 적용

### 5.3 인프라스트럭처 설계
- [x] 5.3.1 PostgreSQL 리포지토리 구현 설계
- [x] 5.3.2 Redis 캐싱 전략 설계
- [x] 5.3.3 검색 인덱스 최적화 설계
- [x] 5.3.4 이벤트 발행/구독 메커니즘 설계

### 5.4 API 설계
- [x] 5.4.1 REST API 엔드포인트 설계
- [x] 5.4.2 요청/응답 DTO 설계
- [x] 5.4.3 페이징 응답 모델 설계
- [x] 5.4.4 오류 처리 및 응답 설계

### 5.5 성능 최적화 설계
- [x] 5.5.1 데이터베이스 쿼리 최적화
- [x] 5.5.2 인덱스 전략 설계
- [x] 5.5.3 캐싱 전략 설계
- [x] 5.5.4 페이징 성능 최적화

### 5.6 보안 및 권한 설계
- [x] 5.6.1 사용자 인증 통합
- [x] 5.6.2 검색 권한 제어
- [x] 5.6.3 공개 카드 접근 제어
- [x] 5.6.4 API 보안 설계

### 5.7 시퀀스 다이어그램 생성
- [x] 5.7.1 내 카드 검색 시퀀스 다이어그램
- [x] 5.7.2 공개 카드 검색 시퀀스 다이어그램
- [x] 5.7.3 공개 카드 저장 시퀀스 다이어그램
- [x] 5.7.4 검색 제안 시퀀스 다이어그램

[Question] 검색 결과 캐싱 전략에서 Redis TTL을 5분으로 설정했는데, 실시간성과 성능 사이의 균형을 위해 다른 TTL 값을 선호하시나요?
[Answer] 내 카드 검색: 3분 TTL + 내가 변경한 경우 캐시 무효화, 공개 카드 검색: 5분 TTL 유지

[Question] 공개 카드 검색에서 관련도 점수 계산 시 제목과 요약 외에 다른 필드(태그, 메모 등)도 포함시키시겠습니까?
[Answer] 제목과 요약만 사용해줘. 태그는 별도 필터이고 메모는 개인적인 내용이라 관련도 계산에서 제외

[Question] 검색 자동완성에서 개인화된 제안(최근 검색어, 내 카드 태그)과 전역 제안(인기 태그) 간의 비율을 어떻게 설정하시겠습니까?
[Answer] 최근 검색어 3개 + 내 카드 태그 4개 + 인기 태그 3개 = 총 10개 제안 

## 검토 및 승인 요청
모든 질문에 대한 답변이 완료되었습니다. 이 계획을 승인해 주시면 단계별로 실행하겠습니다.

### 주요 설계 결정 요약
1. **하이브리드 페이징**: 내 카드(커서) + 공개 카드(오프셋)
2. **검색 제약**: 태그 단일 선택, 공개 카드에서 태그/키워드 중복 사용 금지
3. **자동완성 우선순위**: 최근 검색어 > 내 카드 태그 > 인기 태그
4. **하이라이트**: 클라이언트 처리
5. **공유 카드 저장**: "공유받은 카드" 기본 카테고리 + 사용자 변경 가능
